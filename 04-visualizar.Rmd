# Visualizar {#explore}

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      eval=TRUE,
                      fig.width = 12,
                      fig.height = 8)
options(width = 90)
```

```{r}
library(tidyverse)
```

Una vez que nuestros datos han sido importados y manipulados podríamos comenzar la exploración numérica y visual de los mismos. 

La visualización de datos es parte fundamental del flujo de trabajo de un análisis de datos, tanto para explorar los datos, como para explicar / comunicar los resultados. Es decir, dominar las herramientas de visualización resulta imprescindible para un científico cuya materia prima son los datos.

Los gráficos exploratorios requieren una mínima elaboración, la suficiente para entenderlos y detectar datos anormales (probablemente por error de digitación o outliers).

El paquete [ggplot2](http://r4ds.had.co.nz/data-visualisation.html) se puede utilizar tanto para la creación rápida de gráficos como para gráficos complejos y detallados (con fines de publicaciones científicas). Tiene una gramática propia y la idea original es que un gráfico puede ser elaborado a partir de la combinación de capas, pudiendo tener estas diferentes bases de datos y objetos gráficos (puntos, líneas, barras, etc).

Un mismo dataset puede ser visualizado de múltiples formas, partiendo de la simple visualización de las observaciones con alguna medida de posición como ser la media o mediana. Cuando las observaciones son 5 o más es común acompanãr la media de posición (media o mediana)  por alguna medida de dispersión: desvio estándar, error estándar o intervalo de confianza de la media (95% IC).

A continuación se presentan algunas opciones de gráficos que surgen de diferentes combinaciones de medidas de posición y de dispersión.

## Mancha anillada en soja

```{r}
url1 <- "https://raw.githubusercontent.com/juanchiem/R_Intro/master/data/soja_mancha.csv"
soja <- read.csv(textConnection(RCurl::getURL(url1))) 
```

Nos quedaremos solo con dos cultivares: "BMX_Potencia_RR" y "M9144_RR" (nos aseguraremos que no queden ningun otro nivel del factor cultivar)

```{r}
soja1 <- soja %>%
  filter(cultivar %in% c("BMX_Potencia_RR", "M9144_RR")) %>%
  droplevels()# necesario para remover los cultivares no seleccionados
```

Exploración del dataset

```{r}
ftable(xtabs(~ study + cultivar, soja))
```

Estableceremos quien es el dataset a ser graficado y quienes son las variables en los ejes x e y: 

```{r}
p0 = ggplot(soja, aes(x=sev, y=yield))
p0
```

Agregaremos las observaciones 

```{r}
p0  + geom_point()
```

Identificaremos a que cultivar corresponden las observaciones y agregaremos una línea de tendencia general para cada cultivar:

```{r}
p0 + geom_point(aes(color = cultivar)) +
  geom_smooth(method="lm", aes(color = cultivar))
```

Qué pueden concluir al respecto?

Ahora dividiremos a cada cultivar en paneles individuales e identificaremos las tendencias intra-estudio.   

```{r}
p0 + geom_point(alpha=0.2)+
  geom_smooth(method="lm", aes(group = study))+
  facet_wrap(~cultivar)+
  labs(x="Disease severity (%)", y = "Yield (kg/ha)") +
  theme_bw()
```

Cambiaron los resultados? que puede concluir ahora?

Exploremos el experimento 1

```{r}
soja_exp1 <- soja %>%
  filter(study == 1) %>%
  droplevels()# necesario para remover los cultivares no seleccionados
```

```{r}
# library(Rmisc)
# summarySE(soja_exp1, measurevar="yield", groupvars="fungic")
         
ggplot(soja_exp1, aes(x=fungic, y=yield)) +
  
  # geom_boxplot()+
  
# Observaciones reales -----
  geom_point(alpha=0.2)+  # aes(color=factor(rep)
  # geom_jitter(width = 0.1) 
  
# Medida de posición -----
  stat_summary(fun.y="mean", geom="point", size=2)+
  # stat_summary(fun.y="mean", geom="bar") 
  
# Medida de dispersión -----
  stat_summary(fun.data = mean_se, geom = "errorbar")+
  stat_summary(fun.data= mean_sdl, geom = "errorbar", color="red")+
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color="blue")

```

Afinando la apariencia para paper

```{r}
levels(soja_exp1$fungic)
library(forcats)

soja_exp1 %>% 
  mutate(fungic = fct_recode(fungic, 
                             `Czm` = "CZM[1]",
                             `Czm+CM+Tebu` ="CZM_CM_TEBU[1]",
                             `Czm+LS` = "CZM+LS[1+0.5]",
                             `Epo+Flux+Pyra (0.8L)` = "EPO_FLUX_PYRA[0.8]",
                             `Epo+Flux+Pyra (1L)` ="EPO_FLUX_PYRA[1]",
                             `Fluo` = "FLUO[0.4]",
                             `Prot+Trif` = "PROT_TRIF[0.4]",
                             `Tiof` = "TIOF[1]",
                             `Check` = "ZZ_CHECK"),
         fungic1 = fct_relevel(fungic, 
                              "Check", "Czm", "Czm+CM+Tebu", "Czm+LS", "Epo+Flux+Pyra (0.8L)", "Epo+Flux+Pyra (1L)", "Fluo", "Prot+Trif", "Tiof")) %>% 
ggplot(aes(x = fungic1, y = yield)) +
  geom_boxplot(fill="grey80")+

# Agregamos detalles esteticos
  theme_bw()+
  labs(x="Fungicide treatment", y="Soybean yield (kg/ha)")+
  theme(axis.text.x  = element_text(angle=60, vjust=1, hjust = 1, size=8))

# ggsave(w=80, h=80, units="mm", dpi=150, scale = 1,
# "WORKING_DIRECTORY/plots/plot_1.tiff")
```



## Phoma en colza

"can_phoma" es el dataset de un experimento de colza (*Brassica napus*) donde fueron testeados 10 fungicidas (mas un control sin protección con fungicida) con 3 bloques en que se registró el progreso de manchas foliares de Phoma lingam a través del tiempo (tiempo térmico desde la detección de la primera mancha). La unidad experimental está identificada en la variable "par" la que contiene la información del bloque (1° dígito), y tratamiento (2°-3° digitos).

</br>

![](script/fig/coloni.png)


1 - Importación de datos (desde internet - googlesheets)

```{r}
library(gsheet)

url1="https://docs.google.com/spreadsheets/d/135CDYxoU9KF-Gl32461EWpX0LlXbsSGZ4t_i-0VPpko/edit?usp=sharing"

# browseURL(url1)
can_phoma = gsheet2tbl(url1)

can_phoma
# str(can_phoma)
```

Esto seria uma forma "wide" de representación del dataset (crudo).

Para analizar el efecto del tratamiento fungicida necesitamos calcular el área bajo la curva (AUC) del progreso de la enfermedad. Para esto vamos a transponer can_phoma al formato "long". La función gather (del inglés "reunir", paquete tidyr) apila las columnas que indiquemos.

2 - Manipulación + transformación

Crearemos una variable "tt" con los nombres de las columnas con números, y otra "inc" (incidencia) con los valores correspondientes:

```{r}
can_long <- can_phoma %>% 
  gather(`015`, `058`, `095`, `146`, `165`, `180`, `248`, 
         key = "tt", value = "inc") 
can_long
# str(can_long)
```

Precisamos que tt sea clase "numérica" para ciertos cálculos

```{r}
can_long$tt <- as.numeric(can_long$tt)
# can_long$tt
can_long <- can_long %>% arrange(plot)
str(can_long)
```

Exploramos las evaluaciones originales con gráfico de puntos + líneas individualizando cada parcela en un panel.

```{r}
ggplot(can_long, aes(x=tt, y=inc)) +
  geom_point() +
  geom_line(aes(group=plot)) +
  facet_grid(bk~trt)
```

Verificamos la presencia de errores de tipeo en dos parcelas: 202 y 310. (editamos el dataset original)

```{r, eval=FALSE}
# editar los datos:
can_long<- edit(can_long)
```

Calculamos un valor de AUC por parcela con auxilio de las funciones `group_by` + `summarize` y `agricolae::audpc`

```{r}
# Funcion na.omit
can_auc <- na.omit(can_long) %>% 
  group_by(trt, bk, sev_cank) %>% 
  summarise(auc_i = agricolae::audpc (inc, tt))
can_auc
```

- Exploramos la variable transformada `auc_p` con boxplot

```{r}
ggplot(can_auc, aes(x=factor(trt), y=auc_i)) +
  geom_boxplot()
```

- Exploramos la variable original `sev_cank` con boxplot

```{r}
ggplot(can_auc, aes(x=factor(trt), y=sev_cank)) +
  geom_boxplot()
```

Ahora si, can_phoma está listo para entrar al próximo paso: modelado.


## Fertilización con N y S en sorgo 

```{r}
sorg <- readr::read_csv("~/GitHub/R_Intro/data/sorgo.csv")
```

```{r dat to long, echo=FALSE}
long <- sorg %>%  
  gather(-(trt:planta),  
         key = "variable", value = "valor")
```

- Exploracion de todas las variables

```{r}
# xtabs(~ ferti + cond + dias, long)

pd = position_dodge(width = 0.5)

long %>% drop_na(valor) %>% 

  ggplot(aes(x=factor(hibr), y=valor, group=trt, color=factor(trt))) +
  geom_jitter(alpha=0.5, size=0.8, width=0.2)+
  stat_summary(aes(group=trt), fun.data = mean_cl_boot,
               size = 0.05, position=pd) +
  stat_summary(aes(group=trt), size = 2,
               fun.y="mean", geom="point", position=pd, show.legend = FALSE)+
  facet_wrap(variable ~ ph, scales = "free")
  
# ggsave(filename = "exp3.png", 
#        path = "C:/Users/edwardsmolina.juan/Dropbox/Papers/1 In progress/sorgo_belen/plots")

```

```{r}
library(GGally)
# sorg[,5:11]

ggpairs(sorg, columns = 5:11, ggplot2::aes(colour=ph),
    columnLabels = c("Altura", "Peso seco", "Fosforo total", "Zinc", "Nitrogeno", "Hierro", "Spad"))
```

## Relevamiento de xylella en Olivares
