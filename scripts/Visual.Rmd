---
title: "Visualização de dados"
output: 
  html_document: 
    css: my-style.css
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

A visualização de dados é parte fundamental do workflow de um análise de dados, tanto para explorar os dados, como para explicar/comunicar os resultados. Ou seja, dominar ferramentas de visualização resulta imprescindível para um cientista cuja materia prima são os dados.

O gráficos exploratórios não precissam ser elegantes o com os mesmos detalhes que os explicativos. São mas bem algo proximo a um rascunho, e permitem detectar dados anormais provavelmente por erro de digitação ou outliers per-se. 

O pacote `ggplot2` pode ser usado tanto para a criação rápida de gráficos quanto para gráficos complexos e detalhados (publicações científicas). Este pacote foi desenvolvido por Hadley Wickham que (autor do dplyr, tidyr e outros pacotes fundamentais para analistas de dados). A filosofia por trás do pacote vem da obra "The Grammar of Graphics". A ideia original do pacote é de que um gráfico pode ser elaborado a partir da combinação de vários componentes independentes. Entenda esses componentes como camadas, sendo que cada camada pode ter diferentes banco de dados e objeto de gráficos (pontos, linhas, barras, etc). 

Um mesmo dataset pode ser visualizado de mútiples formas, partindo de a simples visualização das observações com alguma medida de posição como ser a média ou mediana. Uma outra forma mais comunmente utilizada é remplazar as observações por alguma medida de dispersão, como: o desvio padrão da média, erro estándar da média, amplitude interquartílica (IQR, distância das 50% observações centrais), intervalo de confiança da média (95%IC).

A continuação serão apresentadas algumas opções de gráficos que surgem de diferentes combinações de medidas de posição e de dispersão.

# Fator simples

```{r}
library(tidyverse)
```

- Banco de dados (formato long)

```{r}
set.seed(999)
dat_long <- data.frame(trt = factor(rep(1:3, each=5)),
                       y = c(rnorm(5, 4, 2),rnorm(5, 8, 1), rnorm(5, 5, 2))
                       )
```

```{r outliers?, echo=FALSE, eval=FALSE}
# boxplot.stats()$out
source("https://goo.gl/4mthoF")
outlierKD(dat_long %>% filter(trt==1), y)
outlierKD(dat_long %>% filter(trt==2), y)
outlierKD(dat_long %>% filter(trt==3), y)
```

- Sumarizar data

Partindo de uma base de dados formato long podemos calcular as diferentes medidas de posição e dispersão necesárias para a elaboração dos gráficos. 

```{r}
dat_sum <- dat_long %>%
  group_by(trt) %>%
  summarise(mean = mean(y),
                   median = median(y),
                   sd = sd(y),
                   n =  n()) %>%
  mutate(sem = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * sem,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * sem)
dat_sum
```

Anova

```{r}
summary(m1 <- aov(y~trt, dat_long))
out <- agricolae::HSD.test(m1,"trt", group=T)
(let = out$groups)
```

- Gráfico base

```{r}
p0 <- ggplot(dat_sum, aes(x=trt, y=mean)) +
  ylim(0,10)+ ylab("") + 
  xlim("1","2", "3")+  xlab("") +
  theme_classic(base_size = 10) + 
  theme(panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA))  
# p0
```

##1 - Mean + SD

SD is calculated by the formula

$$SD =  \sqrt \frac {\sum (X-M)²} {n−1}$$
where X refers to the individual data points, M is the mean, and Σ (sigma) means add to fi nd the sum, for all the n data points. SD is, roughly, the average or typical difference between the data points and their mean, M. About two thirds of the data points will lie within the region of mean ± 1 SD, and ~95% of the data points will be within 2 SD of the mean.

Descriptive error bars can also be used to see whether a single result fits within the normal range. For example, if you wished to see if a red blood cell count was normal, you could see whether it was within 2 SD of the mean of the population as a whole. Less than 5% of all red blood cell counts are more than 2 SD from the mean, so if the count in question is more than 2 SD from the mean, you might con- sider it to be abnormal.

Like M, SD does not change systematically as n changes, and we can use SD as our best estimate of the un- known σ, whatever the value of n.

```{r}
p1 <- p0 + 
  geom_point(shape = 18, size=3)+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, size=0.3)+ 
  geom_point(data = dat_long, aes(trt, y), alpha=1/10, size=3) + 
  ggtitle("Mean & SD") + 
  geom_text(data= let, aes(label = M, x= trt, y=means,hjust = -1))
# p1
```

To make inferences from the data (i.e., to make a judgment whether the groups are significantly  different, or whether the differences might just be due to random fluctuation or chance), a different type of error bar can be used. These are standard error (SE) bars and confidence intervals (CIs). 

##2 - Mean + SEM

$$SE = \frac {SD}{√n}$$

```{r}
p2 <- p0 + 
  geom_point(shape = 18, size=3)+
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2, size=0.3)+ 
  geom_point(data = dat_long, aes(trt, y), size=3, alpha = 1/10)+ 
  geom_text(data= let, aes(label = M, x= trt, y=means,hjust = -1))+
  ggtitle("Mean & SEM")
# p2
```

##3 - Observações + 95%CI (média)

$$95\%CI = M ± t_{(n–1)} × SE$$

```{r}
p3 <- p0 +
  geom_point(shape = 18, size=3)+
  geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.2, size=0.3) + 
  geom_point(data = dat_long, aes(trt, y), size=3, alpha = 1/10) + 
  geom_text(data= let, aes(label = M, x= trt, y=means,hjust = -1))+
  ggtitle("Mean & 95% CI (mean)") 
# p3
```

**What type of error bar should be used?** 

Because experimental biologists are usually trying to compare experimental results with controls, it is usually appropriate to show inferential error bars, such as SE or CI, rather than SD. However, if n is very small (for example n = 3), rather than showing error bars and statistics, it is better to simply plot the individual data points.


##4 - Barplot + SEM

```{r}
p4  <- p0 +  
  geom_bar(stat="identity",fill="grey80", color="black", size=0.5, width=0.9) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),width=.2, size=0.3) + 
  ggtitle("Barplot & SEM") + 
  geom_text(data= let, aes(label = M, x= trt, y=1, hjust=0.5),size = 4)
# p4
```

##5 - Boxplot + mean

Um boxplot é um sumário gráfico da distribuição de uma amostra que exibe sua forma, tendência central e variabilidade.

Partes de um boxplot

  A: outlier (*): observação que está além do traço superior ou inferior
  
  B: traço superior: representa os 25% superiores da distribuição (excluindo-se outliers)
  
  C: caixa de amplitude interquartílica: 50% do meio dos dados
  
  D: traço inferior representa os 25% inferiores da distribuição (excluindo-se outliers)

```{r}
p5 <- ggplot(dat_long, aes(trt, y)) + 
  geom_boxplot(fill = "grey90", outlier.color=NA) +
  geom_point(data = dat_sum, aes(x = trt, y = mean), shape = 18, size=3)+
  ggtitle("Boxplot & mean") +
  ylim(0,10)+ ylab("") + xlab("") +
  theme_light(base_size = 10)+ 
  theme(panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) + 
  geom_text(data= let, aes(label = M, x= trt, y=9.5))
# p5 
```

##6 - Violin plot

```{r}
p6 <- ggplot(dat_long, aes(trt, y)) + 
  geom_violin(trim=FALSE,fill = "grey90", outlier.color=NA)+
  ylim(0,10)+ ylab("") + xlab("") +
  theme_light(base_size = 10)+ 
  theme(panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA))  +
  labs(title="Violin plot", x="", y="")+
  geom_text(data= let, aes(label = M, x= trt, y=means))
# p6 
```


```{r}
library(cowplot)
plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2)
```

**Estimating statistical significance using the overlap rule for SE bars** 

Here, SE bars are shown on two separate means, for control results C and experimental results E, when n is 3 (left) or n is 10 or more (right). “Gap” refers to the number of error bar arms that would fit between the bottom of the error bars on the controls and the top of the bars on the experimental results; i.e., a gap of 2 means the distance between the C and E error bars is equal to twice the average of the SEs for the two samples. When n = 3, and double the length of the SE error bars just touch (i.e., the gap is 2 SEs), P is ~0.05 (we don’t recommend using error bars where n = 3 or some other very small value, but we include rules to help the reader interpret such figures, which are common in experimental biology).

![](se_bar.png)

**Estimating statistical significance using the overlap rule for 95% CI bars** 

Here, 95% CI bars are shown on two separate means, for control results C and experimental results E, when n is 3 (left) or n is 10 or more (right). “Overlap” refers to the fraction of the average CI error bar arm, i.e., the average of the control (C) and experimental (E) arms. When n ≥ 10, if CI error bars overlap by half the average arm length, P ≈ 0.05. If the tips of the error bars just touch, P ≈ 0.01.

![](ci_bar.png)


# Fatorial duplo (Dados trigo)


```{r}
# load("C:/Users/SILVIA/Dropbox/Events/Cursos/2017_R Epidemio_ESALQ/Aulas/Visualiza??o/trigo.RData")
load("trigo.RData")
# ls()
# 
# tr_wide
# save(tr_wide, file = "C:/Users/SILVIA/Dropbox/Events/Cursos/2017_R Epidemio_ESALQ/Aulas/Visualiza??o/trigo.RData")
```

```{r}
tr_long <- tr_wide %>% 
  gather(spike, sev, -(Treatment:rep)) %>% 
  mutate(timming = as.numeric(as.character(timming))) 
```

```{r}
tr_sum <- tr_long%>% 
  group_by(Treatment, timming) %>%
  summarise(mean = mean(sev, na.rm = TRUE),
            median = median(sev,na.rm = TRUE),
            sd = sd(sev,na.rm = TRUE),
            n = n()) %>%
  mutate(sem = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * sem,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * sem)
tr_sum
```

```{r}
pd <- position_dodge(0.1) # move them .05 to the left and right

ggplot(tr_sum, #%>% filter(fungicide %in% c("Ade", "Caramba", "Prosaro")),
       aes(x=timming, y=mean, colour=Treatment)) + 
  xlim(-1,13)+ ylab("") + 
  scale_x_continuous(breaks = c(0,3,6,9,12))+
  geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.2, position=pd) +
  geom_line(position=pd, size=0.8) +
  geom_point(position=pd, size=2) +
  labs(x="Spray timming (days after anthesis)", y="Disease severity (%)") +
    theme_light(base_size = 14)+ 
  theme(panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) 
```


# Medidas repetidas no tempo (Dados canola)


```{r}
load("canolas.RData")
can_long
can_long$tt <- as.numeric(as.character(can_long$tt))

ggplot(can_long, aes(x=tt, y=incp)) + 
  geom_line(aes(group=par)) + geom_point()+
  scale_x_continuous(breaks = c(50,200))+
  facet_wrap(~par, ncol=11)
```

Parcela 202 tem um dado estranho! Provavelmente erro de digitação.

# Referencias

- http://r4ds.had.co.nz/visualize.html

- http://docs.ggplot2.org/0.9.3.1/index.html

- http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/

- Cumming, G., Fidler, F. and Vaux, D.L., 2007. Error bars in experimental biology. The Journal of cell biology, 177(1), pp.7-11.

