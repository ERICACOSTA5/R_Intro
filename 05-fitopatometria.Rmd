```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      # eval=FALSE, 
                      fig.path = "figures/", 
                      fig.width = 12, 
                      fig.height = 8)
options(width = 90)
library(tidyverse)
```

```{r}
load("data/datos_crudos.RData")
```

# Cálculos fitopatométricos {#fitopato}

## Caso 1: carbón del mani 

![](fig/peanut_smut.png){width=200px}

```{r}
mani <-  mani %>% 
  mutate_at(vars(c("trt", "sprays", "bk")),funs(factor)) 
mani
```

Exploramos cuantas plantas (sub-muestra) fueron evaluadas por parcela:

```{r}
mani %>%
  group_by(trt, sprays, bk)%>%
  summarise(n=n()) #%>% knitr::kable()
```

Calculamos la incidencia por parcela y agregamos una columna para identificar a la planta como sub-muestra dentro de cada parcela:

```{r}
mani1 <- mani %>% 
  mutate(
    trt = relevel(trt, ref="check"),
    dis_pod = rowSums(select(., matches('x1|x2|x3|x4'))),
    inc = dis_pod/n_pods,
    x0_p = rowSums(select(., matches('x0')))/n_pods,
    x3.4 = rowSums(select(., matches('x3|x4'))), 
    sev0_1 = (0*x0 + 0.01*x1 +0.1*x2 + 0.7*x3 + 1*x4)/ n_pods) %>% 
  group_by(sprays, trt, bk) %>%
  mutate(sample = row_number()) %>% 
  
  # filter(sprays!=1, 
  #        trt!="Epoxiconazole") %>%
  ungroup 

mani1
```

## Caso 2: xylella en olivos

![](fig/xylella.jpg)

Chequeamos cuantos árboles fueron evaluados en cada año/región/lote:

```{r}
ftable(xtabs(~year+loc+farm, olivo))
```

Imprimimos los 30 árboles de un mismo lote 

```{r}
olivo %>% 
  arrange(loc, year) %>% 
  print(n=30)
```

### Incidencia (nivel lote - evolución interanual)

```{r}
dat_inc <- olivo %>%
  group_by(year, loc, farm) %>%
  summarise(inc = mean(sev>0, na.rm=TRUE)*100) %>% 
  ungroup %>% 
  arrange(loc, year)
dat_inc
```

```{r}
ggplot(dat_inc, aes(x=factor(year), y=inc, color=factor(farm))) +
  geom_point() +
  geom_line(aes(group=farm)) +
  facet_grid(. ~ loc)
```

### Prevalencia (nivel región - evolución interanual)

```{r}
dat_prev  <- dat_inc %>%
  group_by(year, loc) %>%
  summarise(prev = trunc(mean(inc>0, na.rm=TRUE)*100)) %>% 
  ungroup %>% 
  arrange(loc,year)
dat_prev
```

```{r}
ggplot(dat_prev, aes(x=factor(year), y=prev, color=factor(loc))) +
  geom_point() +
  geom_line(aes(group=loc))
```
